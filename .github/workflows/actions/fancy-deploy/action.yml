name: "Fancy Deploy + Docker + DingTalk"
description: "Docker æ„å»º + SSH éƒ¨ç½² + GPT æ€»ç»“ + é’‰é’‰é€šçŸ¥"

inputs:
  server:
    description: "éƒ¨ç½²æœåŠ¡å™¨ IP"
    required: true
  ssh-private-key:
    description: "SSH ç§é’¥"
    required: true
  docker-username:
    description: "DockerHub ç”¨æˆ·å"
    required: true
  docker-password:
    description: "DockerHub å¯†ç "
    required: true
  dingtalk-webhook:
    description: "é’‰é’‰æœºå™¨äºº webhook"
    required: true
  openai-key:
    description: "DeepSeek / OpenAI å¯†é’¥"
    required: true
  docker-image-tag:
    description: "Docker é•œåƒæ ‡ç­¾"
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      shell: bash
      run: |
        mkdir -p ~/.ssh
        echo "${{ inputs.ssh-private-key }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ inputs.server }} >> ~/.ssh/known_hosts

    - name: ğŸ³ Docker Login
      uses: docker/login-action@v2
      with:
        username: ${{ inputs.docker-username }}
        password: ${{ inputs.docker-password }}

    - name: ğŸ—ï¸ Docker Build & Push
      uses: docker/build-push-action@v4
      with:
        context: .
        file: Dockerfile
        push: true
        tags: ${{ inputs.docker-image-tag }}

    - name: ğŸš€ Remote Deploy
      shell: bash
      run: |
        ssh root@${{ inputs.server }} <<EOF
          cd /opt/vapor
          ./deploy.sh
          EOF

    - name: ğŸ“ˆ Report Build Info
      run: |
        echo "::notice::ğŸ‘¤ User: ${{ github.actor }}"
        echo "::notice::ğŸ”¹ Branch: ${{ github.ref_name }}"
        echo "::notice::ğŸ”¹ Commit: ${{ github.sha }}"
        echo "::notice::â³ Time: $(date '+%Y-%m-%d %H:%M:%S')"

    - name: ğŸ’¬ Generate Deploy Summary with ChatGPT
      id: gpt
      env:
        OPENAI_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      run: |

        # è·å– commit message
        LAST_MSG=$(git log -1 --pretty=%B)
        echo "Commit Message: $LAST_MSG"

        # æ‹¼æ¥å®Œæ•´ content å­—ç¬¦ä¸²
        FULL_CONTENT="è¯·ç”¨ä¸€æ®µå¼€ç©ç¬‘çš„è¯ç®€è¦æ€»ç»“ä¸‹é¢è¿™æ¬¡æäº¤çš„å†…å®¹: $LAST_MSG"
        
        # ç”¨ jq è½¬æˆåˆæ³• JSON å­—ç¬¦ä¸²ï¼ˆå¸¦å¼•å·ã€è½¬ä¹‰ \n ç­‰ï¼‰
        ESCAPED_CONTENT=$(jq -Rn --arg msg "$FULL_CONTENT" '$msg')
        
        # æ„å»º JSON è¯·æ±‚ä½“ï¼ˆç›´æ¥æ’å…¥è½¬ä¹‰å¥½çš„å†…å®¹ï¼‰
        REQUEST_BODY=$(cat <<EOF
        {
          "model": "deepseek-chat",
          "messages": [
            {
              "role": "user",
              "content": $ESCAPED_CONTENT
            }
          ]
        }
        EOF
        )
    
        RESPONSE=$(curl https://api.deepseek.com/chat/completions \
          -s -H "Authorization: Bearer $OPENAI_API_KEY" \
          -H "Content-Type: application/json" \
          -d "$REQUEST_BODY")
    
        echo "Raw Response: $RESPONSE"
        SUMMARY=$(echo "$RESPONSE" | jq -r .choices[0].message.content)
        # âœ… æ—¥å¿—ä¸­è¾“å‡ºæç¤º
        echo "::notice::ğŸ““ ChatGPT Summary: $SUMMARY"
        # âœ… å®‰å…¨å†™å…¥ GITHUB_OUTPUT
        {
        echo 'summary<<EOF'
        echo "$SUMMARY"
        echo 'EOF'
        } >> "$GITHUB_OUTPUT"

    - name: ğŸ“¢ Notify DingTalk
      if: always()
      env:
        DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
        GPT_SUMMARY: ${{ steps.gpt.outputs.summary }}
      run: |
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          TEXT=$(cat <<EOF
          ### ğŸ“œ å¸å›½é€šå‘Š Â·ã€Œ$REPO_NAMEã€å®Œæˆæˆ˜ç•¥çº§éƒ¨ç½² â˜„ï¸
          
          - ğŸ‘¤ äººå‘˜ï¼š\`${{ github.actor }}\`
          - ğŸŒ¿ åˆ†æ”¯ï¼š\`${{ github.ref_name }}\`
          - ğŸ•°ï¸ æ—¶é—´ï¼š\`$NOW\`
          - ğŸ–¥ï¸ æœåŠ¡å™¨ï¼š\`${{ inputs.server }}\`
          
          ---

          $GPT_SUMMARY

          ---
          
          ğŸ‰ æ¬¢è¿å¤§çˆ·ä¸‹æ¬¡å†æ¥ ~
          EOF
          )

          # æ„å»ºåˆæ³• JSON
          JSON_PAYLOAD=$(jq -n --arg title "âœ¨God Modeâœ¨" --arg text "$TEXT" '{
          msgtype: "markdown",
            markdown: {
              title: $title,
              text: $text
            }
          }')

          curl "$DINGTALK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "$JSON_PAYLOAD"

    - name: ğŸ’¥ Print Final ASCII
      run: |
        cat <<'EOF'
           ____       _     __  __           _      
         / ___| ___ | |_  |  \/  | ___   __| | ___ 
        | |  _ / _ \| __| | |\/| |/ _ \ / _` |/ _ \
        | |_| | (_) | |_  | |  | | (_) | (_| |  __/
         \____|\___/ \__| |_|  |_|\___/ \__,_|\___|
        
          âœ¨ GitHub Actions Â· God Mode Engaged âœ¨
        EOF