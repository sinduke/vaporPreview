name: "Fancy Deploy v1.2 + Docker + DingTalk"
description: "æ„å»ºé•œåƒ + ä¸Šä¼  docker-compose.yml + SSH éƒ¨ç½² + GPT æ€»ç»“ + é’‰é’‰é€šçŸ¥"

inputs:
  server:
    description: "éƒ¨ç½²æœåŠ¡å™¨ IP"
    required: true
  ssh-private-key:
    description: "SSH ç§é’¥"
    required: true
  docker-username:
    description: "DockerHub ç”¨æˆ·å"
    required: true
  docker-password:
    description: "DockerHub å¯†ç "
    required: true
  dingtalk-webhook:
    description: "é’‰é’‰æœºå™¨äºº webhook"
    required: true
  openai-key:
    description: "DeepSeek / OpenAI å¯†é’¥"
    required: true
  docker-image-tag:
    description: "Docker é•œåƒæ ‡ç­¾"
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      shell: bash
      run: |
        mkdir -p ~/.ssh
        echo "${{ inputs.ssh-private-key }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ inputs.server }} >> ~/.ssh/known_hosts

    - name: ğŸ³ Docker Login
      uses: docker/login-action@v2
      with:
        username: ${{ inputs.docker-username }}
        password: ${{ inputs.docker-password }}

    # --- ä¿®æ”¹ 1ï¼šåŠ  Docker Buildx å’Œç¼“å­˜ ---
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      # ä½œç”¨ï¼šå¯ç”¨ Buildxï¼Œæ”¯æŒå¤šå±‚ç¼“å­˜ï¼Œæå‡æ„å»ºæ•ˆç‡

    - name: Cache Docker Layers
      uses: actions/cache@v3
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: ${{ runner.os }}-buildx-
      # ä½œç”¨ï¼šç¼“å­˜ Docker æ„å»ºå±‚ï¼Œä»£ç ä¸å˜æ—¶è·³è¿‡ç¼–è¯‘ï¼Œçœ3-4åˆ†é’Ÿ

    - name: ğŸ—ï¸ Docker Build & Push
      uses: docker/build-push-action@v4
      with:
        context: .
        file: Dockerfile
        push: true
        tags: ${{ inputs.docker-image-tag }}
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache,mode=max
      # ä¿®æ”¹ï¼šåŠ äº†ç¼“å­˜å‚æ•°ï¼Œæ„å»ºæ—¶é—´ä»4-5åˆ†é’Ÿé™åˆ°1-2åˆ†é’Ÿï¼ˆç¼“å­˜ç”Ÿæ•ˆæ—¶ï¼‰

    - name: ğŸ“¤ Upload docker-compose.yml to Server
      shell: bash
      run: |
        scp -o StrictHostKeyChecking=no docker-compose.yml root@${{ inputs.server }}:/opt/vapor/docker-compose.yml

    # --- ä¿®æ”¹ 2ï¼šç²¾ç®€ Remote Deployï¼Œä¼˜åŒ–å¥åº·æ£€æŸ¥ ---
    - name: ğŸš€ Remote Deploy
      shell: bash
      run: |
        ssh root@${{ inputs.server }} <<EOF
        set -e
        chmod 644 /opt/vapor/docker-compose.yml
        cd /opt/vapor
        CURRENT_PORT=$(grep -oP 'proxy_pass http://127.0.0.1:\K\d+' /opt/1panel/apps/openresty/openresty/conf/conf.d/test.yiqian.site.conf || echo "8080")
        NEW_PORT=$([ "$CURRENT_PORT" = "8080" ] && echo "8081" || echo "8080")
        NEW_SERVICE=$([ "$NEW_PORT" = "8080" ] && echo "app-blue" || echo "app-green")
        # OLD_SERVICE å®šä¹‰ä¿ç•™ä½†ä¸ç”¨ï¼Œæ³¨é‡Šæ‰ç›¸å…³æ“ä½œ
        # OLD_SERVICE=$([ "$NEW_PORT" = "8080" ] && echo "app-green" || echo "app-blue")
        
        # ä¿®æ”¹ 2.1ï¼šåå°æ‹‰é•œåƒå¹¶ç­‰å¾…ï¼Œæå‡å¹¶è¡Œæ•ˆç‡
        docker-compose pull $NEW_SERVICE & # åå°è·‘ï¼Œçœ10-20ç§’
        wait # ç­‰å¾… pull å®Œæˆ
        
        docker-compose up -d $NEW_SERVICE
        
        # ä¿®æ”¹ 2.2ï¼šå¥åº·æ£€æŸ¥é‡è¯•å‡åŠï¼Œé—´éš”ç¼©çŸ­ï¼Œæ€»ä¸Šé™ä»30ç§’é™åˆ°7.5ç§’
        curl -f --retry 15 --retry-delay 0.5 -H "X-API-Key: sinduke" http://localhost:$NEW_PORT/sinduke/health || exit 1
        
        # ä¿®æ”¹ 2.3ï¼šå»æ‰ OLD_SERVICE çš„ pullã€up å’Œå¥åº·æ£€æŸ¥ï¼Œçœ30-60ç§’
        # docker-compose pull $OLD_SERVICE
        # docker-compose up -d $OLD_SERVICE
        # curl -f --retry 30 --retry-delay 1 -H "X-API-Key: sinduke" http://localhost:$NEW_PORT/sinduke/health || exit 1
        
        sed -i "s/proxy_pass http:\/\/127.0.0.1:$CURRENT_PORT/proxy_pass http:\/\/127.0.0.1:$NEW_PORT/" /opt/1panel/apps/openresty/openresty/conf/conf.d/test.yiqian.site.conf
        systemctl restart 1panel
        echo "âœ… éƒ¨ç½²å®Œæˆ"
        EOF

    - name: ğŸ’¬ Generate Deploy Summary with ChatGPT
      id: gpt
      env:
        OPENAI_API_KEY: ${{ inputs.openai-key }}
      shell: bash
      run: |
        LAST_MSG=$(git log -1 --pretty=%B)
        echo "Commit Message: $LAST_MSG"
        ESCAPED_CONTENT=$(jq -Rn --arg msg "è¯·ç”¨ä¸€æ®µå¼€ç©ç¬‘çš„è¯ç®€è¦æ€»ç»“ä¸‹é¢è¿™æ¬¡æäº¤çš„å†…å®¹: $LAST_MSG" '$msg')
        REQUEST_BODY=$(cat <<EOF
        {
        "model": "deepseek-chat",
        "messages": [
        {
        "role": "user",
        "content": $ESCAPED_CONTENT
        }
        ]
        }
        EOF
        )
        RESPONSE=$(curl https://api.deepseek.com/chat/completions \
          -s -H "Authorization: Bearer $OPENAI_API_KEY" \
          -H "Content-Type: application/json" \
          -d "$REQUEST_BODY")
        SUMMARY=$(echo "$RESPONSE" | jq -r .choices[0].message.content)
        {
          echo "summary<<EOF"
          echo "$SUMMARY"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

    - name: ğŸ“¢ Notify DingTalk
      if: always()
      shell: bash
      env:
        DINGTALK_WEBHOOK: ${{ inputs.dingtalk-webhook }}
        GPT_SUMMARY: ${{ steps.gpt.outputs.summary }}
      run: |
        REPO_NAME="${GITHUB_REPOSITORY##*/}"
        NOW=$(date '+%Y-%m-%d %H:%M:%S')
        TEXT=$(cat <<EOF
        ### ğŸ“œ å¸å›½éƒ¨ç½²æˆåŠŸï¼šã€Œ$REPO_NAMEã€ âš”ï¸
        - ğŸ‘¤ äººå‘˜ï¼š\`${{ github.actor }}\`
        - ğŸŒ¿ åˆ†æ”¯ï¼š\`${{ github.ref_name }}\`
        - ğŸ•°ï¸ æ—¶é—´ï¼š\`$NOW\`
        - ğŸ–¥ï¸ æœåŠ¡å™¨ï¼š\`${{ inputs.server }}\`
        ---
        $GPT_SUMMARY
        ---
        ğŸ‰ By Swift Vapor ~
        EOF
        )
        JSON_PAYLOAD=$(jq -n --arg title "âœ¨God Modeâœ¨" --arg text "$TEXT" '{msgtype: "markdown", markdown: {title: $title, text: $text}}')
        curl "$DINGTALK_WEBHOOK" \
          -H 'Content-Type: application/json' \
          -d "$JSON_PAYLOAD"

    - name: ğŸ’¥ Print Final ASCII
      shell: bash
      run: |
        cat <<'EOF'
           ____       _     __  __           _      
         / ___| ___ | |_  |  \/  | ___   __| | ___ 
        | |  _ / _ \| __| | |\/| |/ _ \ / _` |/ _ \
        | |_| | (_) | |_  | |  | | (_) | (_| |  __/
         \____|\___/ \__| |_|  |_|\___/ \__,_|\___|
          âœ¨ GitHub Actions Â· God Mode Engaged âœ¨
        EOF

# name: "Fancy Deploy v1.2 + Docker + DingTalk"
# description: "æ„å»ºé•œåƒ + ä¸Šä¼  docker-compose.yml + SSH éƒ¨ç½² + GPT æ€»ç»“ + é’‰é’‰é€šçŸ¥"

# inputs:
#   server:
#     description: "éƒ¨ç½²æœåŠ¡å™¨ IP"
#     required: true
#   ssh-private-key:
#     description: "SSH ç§é’¥"
#     required: true
#   docker-username:
#     description: "DockerHub ç”¨æˆ·å"
#     required: true
#   docker-password:
#     description: "DockerHub å¯†ç "
#     required: true
#   dingtalk-webhook:
#     description: "é’‰é’‰æœºå™¨äºº webhook"
#     required: true
#   openai-key:
#     description: "DeepSeek / OpenAI å¯†é’¥"
#     required: true
#   docker-image-tag:
#     description: "Docker é•œåƒæ ‡ç­¾"
#     required: true

# runs:
#   using: "composite"
#   steps:
#     - uses: actions/checkout@v4

#     - name: ğŸ” Setup SSH
#       shell: bash
#       run: |
#         mkdir -p ~/.ssh
#         echo "${{ inputs.ssh-private-key }}" > ~/.ssh/id_rsa
#         chmod 600 ~/.ssh/id_rsa
#         ssh-keyscan -H ${{ inputs.server }} >> ~/.ssh/known_hosts

#     - name: ğŸ³ Docker Login
#       uses: docker/login-action@v2
#       with:
#         username: ${{ inputs.docker-username }}
#         password: ${{ inputs.docker-password }}

#     - name: ğŸ—ï¸ Docker Build & Push
#       uses: docker/build-push-action@v4
#       with:
#         context: .
#         file: Dockerfile
#         push: true
#         tags: ${{ inputs.docker-image-tag }}

#     - name: ğŸ“¤ Upload docker-compose.yml to Server
#       shell: bash
#       run: |
#         scp -o StrictHostKeyChecking=no docker-compose.yml root@${{ inputs.server }}:/opt/vapor/docker-compose.yml

#     - name: ğŸš€ Remote Deploy
#       shell: bash
#       run: |
#         ssh root@${{ inputs.server }} <<EOF
#         set -e
#         echo "ğŸ” æ£€æŸ¥ docker-compose.yml æƒé™"
#         chmod 644 /opt/vapor/docker-compose.yml

#         echo "ğŸš€ å¼€å§‹éƒ¨ç½²æµç¨‹"
#         cd /opt/vapor

#         CURRENT_PORT=$(grep -oP 'proxy_pass http://127.0.0.1:\K\d+' /opt/1panel/apps/openresty/openresty/conf/conf.d/test.yiqian.site.conf || echo "8080")
#         NEW_PORT=$([ "$CURRENT_PORT" = "8080" ] && echo "8081" || echo "8080")
#         NEW_SERVICE=$([ "$NEW_PORT" = "8080" ] && echo "app-blue" || echo "app-green")
#         OLD_SERVICE=$([ "$NEW_PORT" = "8080" ] && echo "app-green" || echo "app-blue")

#         docker-compose pull $NEW_SERVICE
#         docker-compose up -d $NEW_SERVICE
#         curl -f --retry 30 --retry-delay 1 -H "X-API-Key: sinduke" http://localhost:$NEW_PORT/sinduke/health || exit 1

#         docker-compose pull $OLD_SERVICE
#         docker-compose up -d $OLD_SERVICE
#         curl -f --retry 30 --retry-delay 1 -H "X-API-Key: sinduke" http://localhost:$NEW_PORT/sinduke/health || exit 1

#         sed -i "s/proxy_pass http:\/\/127.0.0.1:$CURRENT_PORT/proxy_pass http:\/\/127.0.0.1:$NEW_PORT/" /opt/1panel/apps/openresty/openresty/conf/conf.d/test.yiqian.site.conf
#         systemctl restart 1panel
#         echo "âœ… éƒ¨ç½²å®Œæˆ"
#         EOF

#     - name: ğŸ’¬ Generate Deploy Summary with ChatGPT
#       id: gpt
#       env:
#         OPENAI_API_KEY: ${{ inputs.openai-key }}
#       shell: bash
#       run: |

#         LAST_MSG=$(git log -1 --pretty=%B)
#         echo "Commit Message: $LAST_MSG"
#         ESCAPED_CONTENT=$(jq -Rn --arg msg "è¯·ç”¨ä¸€æ®µå¼€ç©ç¬‘çš„è¯ç®€è¦æ€»ç»“ä¸‹é¢è¿™æ¬¡æäº¤çš„å†…å®¹: $LAST_MSG" '$msg')

#         REQUEST_BODY=$(cat <<EOF
#         {
#         "model": "deepseek-chat",
#         "messages": [
#         {
#         "role": "user",
#         "content": $ESCAPED_CONTENT
#         }
#         ]
#         }
#         EOF
#         )

#         RESPONSE=$(curl https://api.deepseek.com/chat/completions \
#           -s -H "Authorization: Bearer $OPENAI_API_KEY" \
#           -H "Content-Type: application/json" \
#           -d "$REQUEST_BODY")

#         SUMMARY=$(echo "$RESPONSE" | jq -r .choices[0].message.content)
#         {
#           echo "summary<<EOF"
#           echo "$SUMMARY"
#           echo "EOF"
#         } >> "$GITHUB_OUTPUT"

#     - name: ğŸ“¢ Notify DingTalk
#       if: always()
#       shell: bash
#       env:
#         DINGTALK_WEBHOOK: ${{ inputs.dingtalk-webhook }}
#         GPT_SUMMARY: ${{ steps.gpt.outputs.summary }}
#       run: |
#         REPO_NAME="${GITHUB_REPOSITORY##*/}"
#         NOW=$(date '+%Y-%m-%d %H:%M:%S')
#         TEXT=$(cat <<EOF
#         ### ğŸ“œ å¸å›½éƒ¨ç½²æˆåŠŸï¼šã€Œ$REPO_NAMEã€ âš”ï¸

#         - ğŸ‘¤ äººå‘˜ï¼š\`${{ github.actor }}\`
#         - ğŸŒ¿ åˆ†æ”¯ï¼š\`${{ github.ref_name }}\`
#         - ğŸ•°ï¸ æ—¶é—´ï¼š\`$NOW\`
#         - ğŸ–¥ï¸ æœåŠ¡å™¨ï¼š\`${{ inputs.server }}\`

#         ---

#         $GPT_SUMMARY

#         ---

#         ğŸ‰ By Swift Vapor ~
#         EOF
#         )
        
#         # Send to DingTalk
#         JSON_PAYLOAD=$(jq -n --arg title "âœ¨God Modeâœ¨" --arg text "$TEXT" '{msgtype: "markdown", markdown: {title: $title, text: $text}}')
#         curl "$DINGTALK_WEBHOOK" \
#           -H 'Content-Type: application/json' \
#           -d "$JSON_PAYLOAD"

#     - name: ğŸ’¥ Print Final ASCII
#       shell: bash
#       run: |
#         cat <<'EOF'
#            ____       _     __  __           _      
#          / ___| ___ | |_  |  \/  | ___   __| | ___ 
#         | |  _ / _ \| __| | |\/| |/ _ \ / _` |/ _ \
#         | |_| | (_) | |_  | |  | | (_) | (_| |  __/
#          \____|\___/ \__| |_|  |_|\___/ \__,_|\___|
        
#           âœ¨ GitHub Actions Â· God Mode Engaged âœ¨
#         EOF