name: "Fancy Deploy v1.2 + Docker + DingTalk"
description: "æ„å»ºé•œåƒ + ä¸Šä¼  docker-compose.yml + SSH éƒ¨ç½² + GPT æ€»ç»“ + é’‰é’‰é€šçŸ¥"

inputs:
  server:
    description: "éƒ¨ç½²æœåŠ¡å™¨ IP"
    required: true
  ssh-private-key:
    description: "SSH ç§é’¥"
    required: true
  docker-username:
    description: "DockerHub ç”¨æˆ·å"
    required: true
  docker-password:
    description: "DockerHub å¯†ç "
    required: true
  dingtalk-webhook:
    description: "é’‰é’‰æœºå™¨äºº webhook"
    required: true
  openai-key:
    description: "DeepSeek / OpenAI å¯†é’¥"
    required: true
  docker-image-tag:
    description: "Docker é•œåƒæ ‡ç­¾"
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      shell: bash
      run: |
        mkdir -p ~/.ssh
        echo "${{ inputs.ssh-private-key }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ inputs.server }} >> ~/.ssh/known_hosts

    - name: ğŸ³ Docker Login
      uses: docker/login-action@v2
      with:
        username: ${{ inputs.docker-username }}
        password: ${{ inputs.docker-password }}

    # æš‚æ—¶å…³é—­æ‰“åŒ…å’Œä¸Šä¼ çš„éƒ¨åˆ† èŠ‚çº¦æµ‹è¯•æ—¶é—´
    # - name: ğŸ—ï¸ Docker Build & Push
    #   uses: docker/build-push-action@v4
    #   with:
    #     context: .
    #     file: Dockerfile
    #     push: true
    #     tags: ${{ inputs.docker-image-tag }}

    - name: ğŸ“¤ Upload docker-compose.yml to Server
      shell: bash
      run: |
        scp -o StrictHostKeyChecking=no docker-compose.yml root@${{ inputs.server }}:/opt/vapor/docker-compose.yml

    - name: ğŸš€ Remote Deploy
      shell: bash
      run: |
        ssh root@${{ inputs.server }} <<EOF
        set -e
        echo "ğŸ” æ£€æŸ¥ docker-compose.yml æƒé™"
        chmod 644 /opt/vapor/docker-compose.yml

        echo "ğŸš€ å¼€å§‹éƒ¨ç½²æµç¨‹"
        cd /opt/vapor

        CURRENT_PORT=$(grep -oP 'proxy_pass http://127.0.0.1:\K\d+' /opt/1panel/apps/openresty/openresty/conf/conf.d/test.yiqian.site.conf || echo "8080")
        NEW_PORT=$([ "$CURRENT_PORT" = "8080" ] && echo "8081" || echo "8080")
        NEW_SERVICE=$([ "$NEW_PORT" = "8080" ] && echo "app-blue" || echo "app-green")
        OLD_SERVICE=$([ "$NEW_PORT" = "8080" ] && echo "app-green" || echo "app-blue")

        docker-compose pull $NEW_SERVICE
        docker-compose up -d $NEW_SERVICE
        sleep 30
        curl -f -H "X-API-Key: sinduke" http://localhost:$NEW_PORT/sinduke/health || exit 1

        docker-compose pull $OLD_SERVICE
        docker-compose up -d $OLD_SERVICE
        sleep 30
        curl -f -H "X-API-Key: sinduke" http://localhost:$CURRENT_PORT/sinduke/health || exit 1

        sed -i "s/proxy_pass http:\/\/127.0.0.1:$CURRENT_PORT/proxy_pass http:\/\/127.0.0.1:$NEW_PORT/" /opt/1panel/apps/openresty/openresty/conf/conf.d/test.yiqian.site.conf
        systemctl restart 1panel
        echo "âœ… éƒ¨ç½²å®Œæˆ"
        EOF

    - name: ğŸ’¬ Generate Deploy Summary with ChatGPT
      id: gpt
      env:
        OPENAI_API_KEY: ${{ inputs.openai-key }}
      shell: bash
      run: |

        LAST_MSG=$(git log -1 --pretty=%B)
        echo "Commit Message: $LAST_MSG"
        ESCAPED_CONTENT=$(jq -Rn --arg msg "è¯·ç”¨ä¸€æ®µå¼€ç©ç¬‘çš„è¯ç®€è¦æ€»ç»“ä¸‹é¢è¿™æ¬¡æäº¤çš„å†…å®¹: $LAST_MSG" '$msg')

        REQUEST_BODY=$(cat <<EOF
        {
        "model": "deepseek-chat",
        "messages": [
        {
        "role": "user",
        "content": $ESCAPED_CONTENT
        }
        ]
        }
        EOF
        )

        RESPONSE=$(curl https://api.deepseek.com/chat/completions \
          -s -H "Authorization: Bearer $OPENAI_API_KEY" \
          -H "Content-Type: application/json" \
          -d "$REQUEST_BODY")

        SUMMARY=$(echo "$RESPONSE" | jq -r .choices[0].message.content)
        {
          echo "summary<<EOF"
          echo "$SUMMARY"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

    - name: ğŸ“¢ Notify DingTalk
      if: always()
      shell: bash
      env:
        DINGTALK_WEBHOOK: ${{ inputs.dingtalk-webhook }}
        GPT_SUMMARY: ${{ steps.gpt.outputs.summary }}
      run: |
        REPO_NAME="${GITHUB_REPOSITORY##*/}"
        NOW=$(date '+%Y-%m-%d %H:%M:%S')
        TEXT=$(cat <<EOF
        ### ğŸ“œ å¸å›½éƒ¨ç½²æˆåŠŸï¼šã€Œ$REPO_NAMEã€ âš”ï¸

        - ğŸ‘¤ äººå‘˜ï¼š\`${{ github.actor }}\`
        - ğŸŒ¿ åˆ†æ”¯ï¼š\`${{ github.ref_name }}\`
        - ğŸ•°ï¸ æ—¶é—´ï¼š\`$NOW\`
        - ğŸ–¥ï¸ æœåŠ¡å™¨ï¼š\`${{ inputs.server }}\`

        ---

        $GPT_SUMMARY

        ---

        ğŸ‰ æ¬¢è¿å¤§çˆ·ä¸‹æ¬¡å†æ¥ ~
        EOF
        )
        
        # Send to DingTalk
        JSON_PAYLOAD=$(jq -n --arg title "âœ¨God Modeâœ¨" --arg text "$TEXT" '{msgtype: "markdown", markdown: {title: $title, text: $text}}')
        curl "$DINGTALK_WEBHOOK" \
          -H 'Content-Type: application/json' \
          -d "$JSON_PAYLOAD"

    - name: ğŸ’¥ Print Final ASCII
      shell: bash
      run: |
        cat <<EOF
           ____       _     __  __           _      
         / ___| ___ | |_  |  \/  | ___   __| | ___ 
        | |  _ / _ \| __| | |\/| |/ _ \ / _` |/ _ \
        | |_| | (_) | |_  | |  | | (_) | (_| |  __/
         \____|\___/ \__| |_|  |_|\___/ \__,_|\___|
        
          âœ¨ GitHub Actions Â· God Mode Engaged âœ¨
        EOF